<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>End-to-End Service Management â€” MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1220; --card:#131a2a; --muted:#91a3b0; --text:#e8eef4; --accent:#4fd1c5; --accent2:#7aa2f7; }
    * { box-sizing: border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    body { margin:0; background:linear-gradient(180deg, #0b1220, #0e1628 70%); color:var(--text); }
    header { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid #1f2740; }
    header h1 { margin:0; font-size:18px; font-weight:600; letter-spacing:.3px; }
    .api-box { display:flex; gap:8px; align-items:center; }
    .api-box input { width:420px; max-width:65vw; background:#0f172a; color:var(--text); border:1px solid #27314f; padding:8px 10px; border-radius:10px; }
    .btn { background:linear-gradient(90deg, var(--accent), var(--accent2)); border:none; color:#0b1220; padding:9px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
    .wrap { max-width:1100px; margin:24px auto; padding:0 16px 40px; }
    .tabs { display:flex; gap:10px; margin:10px 0 16px; }
    .tab { padding:10px 14px; border-radius:10px; background:#0f172a; border:1px solid #27314f; color:var(--muted); cursor:pointer; }
    .tab.active { color:var(--text); border-color:#3a4a79; }
    .grid { display:grid; grid-template-columns:repeat(2, minmax(260px, 1fr)); gap:14px; }
    .card { background:var(--card); border:1px solid #223055; border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.15); }
    label { font-size:12px; color:#a9b7c4; display:block; margin-bottom:6px; }
    input, textarea, select { width:100%; background:#0f172a; color:var(--text); border:1px solid #27314f; padding:9px 12px; border-radius:10px; }
    textarea { min-height:72px; resize:vertical; }
    .row { display:flex; gap:12px; }
    .row > * { flex:1; }
    .actions { display:flex; gap:10px; align-items:center; margin-top:10px; }
    pre { background:#0f172a; color:#d7e3ee; padding:12px; border:1px solid #27314f; border-radius:10px; overflow:auto; max-height:360px; }
    small.hint { color:#93a1b3; display:block; margin-top:6px; }
    .ok { color:#6ee7b7; }
    .err { color:#fca5a5; }
    @media (max-width: 860px){ .grid { grid-template-columns:1fr; } .api-box input { max-width:50vw; } }
  </style>
</head>
<body>

<header>
  <h1>ðŸ”§ End-to-End Service Management â€” MVP</h1>
  <div class="api-box">
    <label for="apiUrl" style="font-size:12px;color:#a9b7c4">API URL</label>
    <input id="apiUrl" placeholder="http://3.105.229.165:8000" />
    <button class="btn" id="saveApiBtn">Save</button>
  </div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tab active" data-tab="book">Book Service</button>
    <button class="tab" data-tab="status">Status & Chat</button>
    <button class="tab" data-tab="chatbot">Chatbot Booking</button>
  </div>

  <!-- BOOK SERVICE -->
  <section id="book" class="card">
    <h2>Book a Service</h2>
    <div class="grid">
      <div><label>Name</label><input id="name" placeholder="John Doe" /></div>
      <div><label>Phone</label><input id="phone" placeholder="+8869..." /></div>
      <div><label>Email</label><input id="email" placeholder="john@example.com" /></div>
      <div><label>Issue</label><input id="issue" placeholder="brake replacement" /></div>
      <div><label>Date</label><input id="date" placeholder="2025-08-18" /><small class="hint">YYYY-MM-DD</small></div>
      <div class="row"><div><label>Start</label><input id="start" placeholder="10:00" /></div><div><label>End</label><input id="end" placeholder="12:00" /></div></div>
      <div><label>Address</label><input id="address" placeholder="Taipei City" /></div>
      <div class="row"><div><label>Latitude</label><input id="lat" placeholder="25.04" /></div><div><label>Longitude</label><input id="lon" placeholder="121.55" /></div></div>
    </div>
    <div class="actions">
      <button class="btn" id="bookBtn">Book</button>
      <span id="bookStatus"></span>
    </div>
    <h3>Response</h3>
    <pre id="bookOut">{}</pre>
  </section>

  <!-- STATUS -->
  <section id="status" class="card" style="display:none">
    <h2>Status & Chat</h2>
    <div class="row">
      <div>
        <label>Job ID</label>
        <input id="jobId" placeholder="JOB#xxxx" />
        <small class="hint">Weâ€™ll auto-fill from your last booking if available.</small>
      </div>
      <div class="actions">
        <button class="btn" id="statusBtn">Get Status</button>
      </div>
    </div>
    <h3>Status</h3>
    <pre id="statusOut">{}</pre>
    <h3>Ask a question</h3>
    <div class="row"><input id="q" placeholder="What's my ETA?" /><button class="btn" id="askBtn">Ask</button></div>
    <pre id="chatOut"></pre>
  </section>

  <!-- CHATBOT -->
  <section id="chatbot" class="card" style="display:none">
    <h2>Chatbot Booking</h2>
    <div id="chatWindow" style="background:#0f172a; border:1px solid #27314f; border-radius:10px; padding:10px; height:300px; overflow-y:auto; margin-bottom:10px;"></div>
    <div class="row">
      <input id="chatInput" placeholder="Say something..." />
      <button class="btn" id="chatSendBtn">Send</button>
    </div>
  </section>
</div>

<script>
(function(){
  const apiInput = document.getElementById('apiUrl');
  const saveApiBtn = document.getElementById('saveApiBtn');
  const tabs = document.querySelectorAll('.tab');
  const sections = { 
    book: document.getElementById('book'), 
    status: document.getElementById('status'),
    chatbot: document.getElementById('chatbot')
  };

  apiInput.value = localStorage.getItem('API_URL') || '';
  saveApiBtn.onclick = () => {
    const v = apiInput.value.trim();
    if(!v){ alert('Enter your FastAPI base URL'); return; }
    localStorage.setItem('API_URL', v);
    alert('Saved!');
  };
  const API = () => (localStorage.getItem('API_URL') || '').replace(/\/+$/,'');

  tabs.forEach(t => t.onclick = () => {
    tabs.forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    const target = t.dataset.tab;
    Object.keys(sections).forEach(k => sections[k].style.display = (k === target) ? '' : 'none');
  });

  const j = (o) => JSON.stringify(o, null, 2);

  // BOOK
  document.getElementById('bookBtn').onclick = async () => {
    try{
      const base = API(); if(!base) return alert('Set API URL first.');
      const body = {
        name:  name.value.trim(),
        phone: phone.value.trim(),
        email: email.value.trim(),
        issue: issue.value.trim(),
        date:  date.value.trim(),
        start: start.value.trim(),
        end:   end.value.trim(),
        address: address.value.trim(),
        lat:   parseFloat(lat.value.trim()),
        lon:   parseFloat(lon.value.trim())
      };
      const resp = await fetch(`${base}/book`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(body) });
      const data = await resp.json();
      bookOut.textContent = j(data);
      if (resp.ok && data.jobId) {
        bookStatus.innerHTML = `<span class="ok">Booked âœ”</span>`;
        localStorage.setItem('LAST_JOB_ID', data.jobId);
        jobId.value = data.jobId;
      } else {
        bookStatus.innerHTML = `<span class="err">Error</span>`;
      }
    } catch(err){ bookStatus.innerHTML = `<span class="err">Error</span>`; bookOut.textContent = err.message; }
  };

  // STATUS
  jobId.value = localStorage.getItem('LAST_JOB_ID') || '';
  document.getElementById('statusBtn').onclick = async () => {
    try{
      const base = API(); if(!base) return alert('Set API URL first.');
      const id = jobId.value.trim() || localStorage.getItem('LAST_JOB_ID');
      if(!id) return alert('Enter a Job ID.');
      const r = await fetch(`${base}/status/${encodeURIComponent(id)}`);
      statusOut.textContent = j(await r.json());
    } catch(err){ statusOut.textContent = err.message; }
  };

  document.getElementById('askBtn').onclick = async () => {
    try{
      const base = API(); if(!base) return alert('Set API URL first.');
      const id = jobId.value.trim();
      if(!id) return alert('Enter a Job ID.');
      const qVal = q.value.trim() || "What's my ETA?";
      const r = await fetch(`${base}/chat`, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ jobId:id, question:qVal }) });
      chatOut.textContent = j(await r.json());
    } catch(err){ chatOut.textContent = err.message; }
  };

  // CHATBOT
  const chatWindow = document.getElementById('chatWindow');
  const chatInput = document.getElementById('chatInput');
  const chatSendBtn = document.getElementById('chatSendBtn');

  function addChatBubble(text, sender) {
    const bubble = document.createElement('div');
    bubble.style.padding = '8px 10px';
    bubble.style.margin = '6px 0';
    bubble.style.borderRadius = '8px';
    bubble.style.maxWidth = '80%';
    bubble.style.whiteSpace = 'pre-wrap';
    if (sender === 'user') {
      bubble.style.background = '#4fd1c5'; bubble.style.color = '#0b1220'; bubble.style.marginLeft = 'auto';
    } else {
      bubble.style.background = '#27314f'; bubble.style.color = '#e8eef4'; bubble.style.marginRight = 'auto';
    }
    bubble.textContent = text;
    chatWindow.appendChild(bubble);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  let CHATBOT_SESSION = localStorage.getItem('CHATBOT_SESSION') || `sess_${Date.now()}`;
  localStorage.setItem('CHATBOT_SESSION', CHATBOT_SESSION);

  async function sendChatMessage() {
    const msg = chatInput.value.trim();
    if (!msg) return;
    addChatBubble(msg, 'user');
    chatInput.value = '';
    try {
      const base = API(); if (!base) return alert('Set API URL first.');
      const resp = await fetch(`${base}/chatbot_llm`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: CHATBOT_SESSION, message: msg }) });
      const data = await resp.json();
      addChatBubble(data.reply || '(No reply)', 'assistant');
      if (data.reply && data.reply.includes('âœ… Booking confirmed!')) {
        const match = data.reply.match(/JOB#[\w-]+/);
        if (match) { localStorage.setItem('LAST_JOB_ID', match[0]); jobId.value = match[0]; }
      }
    } catch (err) {
      addChatBubble(`Error: ${err.message}`, 'assistant');
    }
  }

  chatSendBtn.onclick = sendChatMessage;
  chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendChatMessage(); });

})();
</script>
</body>
</html>
